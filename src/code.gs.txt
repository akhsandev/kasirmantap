/**
 * SISTEM KASIR RUKO POS BACKEND (GAS) v6 - FINAL STABLE
 * Fitur: Smart Overwrite (Mencegah Double Deduction), Support Diskon, & Expenses.
 */

const SHEET_PRODUCTS = "Products";
const SHEET_TRANSACTIONS = "Transactions";
const SHEET_EXPENSES = "Expenses";

function onOpen() {
  SpreadsheetApp.getUi().createMenu('ðŸª Admin Ruko POS')
      .addItem('âš¡ Setup Database', 'setupDatabase')
      .addToUi();
}

function doGet(e) {
  const action = e.parameter.action;
  if (action == "get_products") return getProducts();
  return responseJSON({status: 'error', message: 'Unknown action'});
}

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action;

    // SATU-SATUNYA PINTU MASUK SINKRONISASI YANG AMAN
    // Kita hapus 'sync_data' biasa untuk memaksa penggunaan 'overwrite_full' demi keamanan stok.
    if (action == "overwrite_full") {
      return overwriteFull(data.products, data.transactions, data.expenses);
    } else if (action == "sync_data") {
       // Fallback untuk kompatibilitas, tapi disarankan pakai overwrite_full
       return syncData(data.transactions, data.expenses);
    }
    
    return responseJSON({status: 'error', message: 'Unknown action'});
  } catch (err) {
    return responseJSON({status: 'error', message: err.toString()});
  }
}

// --- LOGIKA DATABASE ---

function getProducts() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEET_PRODUCTS);
  if (!sheet) return responseJSON({status: 'error', message: 'Database belum disetup.'});
  
  const data = sheet.getDataRange().getValues();
  data.shift(); // Hapus header
  
  const products = data.map(row => ({
    barcode: String(row[0]).replace(/^'/, ""),
    name: row[1],
    category: row[2],
    price: Number(row[3]),
    cost_price: Number(row[4]),
    stock: Number(row[5]),
    image: row[6]
  }));

  return responseJSON({status: 'success', products: products});
}

// FUNGSI INTI: Menimpa Stok (Master) & Mencatat History
function overwriteFull(products, transactions, expenses) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheetProd = ss.getSheetByName(SHEET_PRODUCTS);
  let sheetTx = ss.getSheetByName(SHEET_TRANSACTIONS);
  let sheetExp = ss.getSheetByName(SHEET_EXPENSES);

  if (!sheetProd || !sheetTx || !sheetExp) { 
    setupDatabase(); 
    return responseJSON({status: 'error', message: 'Database baru disetup. Silakan coba lagi.'});
  }

  // 1. UPDATE STOK: Timpa total dengan data terbaru dari HP (Source of Truth)
  // Ini mencegah "Double Reduction" karena kita tidak mengurangi stok lagi, tapi menyamakan angkanya.
  if (sheetProd.getLastRow() > 1) {
    sheetProd.getRange(2, 1, sheetProd.getLastRow() - 1, sheetProd.getLastColumn()).clearContent();
  }
  if (products.length > 0) {
    const rows = products.map(p => [
      `'${p.barcode}`, p.name, p.category || 'Umum', p.price, p.cost_price || 0, p.stock, p.image || ''
    ]);
    sheetProd.getRange(2, 1, rows.length, rows[0].length).setValues(rows);
  }

  // 2. CATAT LOG TRANSAKSI BARU (Hanya Append, Tanpa Logika Stok)
  if (transactions && transactions.length > 0) {
    const txRows = transactions.map(t => [
      new Date(t.date).toLocaleString('id-ID'),
      t.total, t.discount || 0, t.finalTotal || t.total, t.profit || 0,
      t.type === 'debt' ? `KASBON (${t.customerName})` : 'TUNAI',
      JSON.stringify(t.items.map(i => `${i.name} x${i.qty}`)).replace(/[\[\]"]/g, '')
    ]);
    sheetTx.getRange(sheetTx.getLastRow() + 1, 1, txRows.length, 7).setValues(txRows);
  }

  // 3. CATAT PENGELUARAN BARU
  if (expenses && expenses.length > 0) {
    const expRows = expenses.map(e => [
      new Date(e.date).toLocaleString('id-ID'), e.desc, e.amount
    ]);
    sheetExp.getRange(sheetExp.getLastRow() + 1, 1, expRows.length, 3).setValues(expRows);
  }

  return responseJSON({status: 'success', message: 'Data Server Berhasil Disamakan dengan HP!'});
}

function syncData(transactions, expenses) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheetTx = ss.getSheetByName(SHEET_TRANSACTIONS);
  const sheetExp = ss.getSheetByName(SHEET_EXPENSES);
  const sheetProd = ss.getSheetByName(SHEET_PRODUCTS);

  // LOGIC LAMA (Hanya backup, tidak dipakai jika lewat overwrite_full)
  // Masih ada resiko double cut jika dipakai manual tanpa overwrite
  if (transactions && transactions.length > 0) {
    const txRows = transactions.map(t => [
      new Date(t.date).toLocaleString('id-ID'),
      t.total, t.discount || 0, t.finalTotal || t.total, t.profit || 0,
      t.type === 'debt' ? `KASBON (${t.customerName})` : 'TUNAI',
      JSON.stringify(t.items.map(i => `${i.name} x${i.qty}`)).replace(/[\[\]"]/g, '')
    ]);
    sheetTx.getRange(sheetTx.getLastRow() + 1, 1, txRows.length, 7).setValues(txRows);
    
    let productData = sheetProd.getDataRange().getValues();
    let pMap = new Map();
    productData.forEach((row, idx) => { pMap.set(String(row[0]).replace(/^'/, ""), idx); });

    let isUpdated = false;
    transactions.forEach(tx => {
      tx.items.forEach(item => {
        let idx = pMap.get(String(item.barcode));
        if(idx === undefined) { const foundIdx = productData.findIndex(r => r[1] === item.name); if(foundIdx > -1) idx = foundIdx; }
        if (idx !== undefined && idx > 0) {
          let curStock = Number(productData[idx][5]);
          productData[idx][5] = curStock - item.qty;
          isUpdated = true;
        }
      });
    });
    if (isUpdated) {
      sheetProd.getRange(1, 1, productData.length, productData[0].length).setValues(productData);
    }
  }

  if (expenses && expenses.length > 0) {
    const expRows = expenses.map(e => [new Date(e.date).toLocaleString('id-ID'), e.desc, e.amount]);
    sheetExp.getRange(sheetExp.getLastRow() + 1, 1, expRows.length, 3).setValues(expRows);
  }

  const updatedData = sheetProd.getDataRange().getValues();
  updatedData.shift(); 
  const updatedProducts = updatedData.map(row => ({
    barcode: String(row[0]).replace(/^'/, ""),
    name: row[1],
    category: row[2],
    price: Number(row[3]),
    cost_price: Number(row[4]),
    stock: Number(row[5]),
    image: row[6]
  }));

  return responseJSON({ status: 'success', updatedProducts: updatedProducts });
}

function setupDatabase() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const schema = {
    "Products": ["Barcode", "Name", "Category", "Price", "Cost Price", "Stock", "Image"],
    "Transactions": ["Date", "Subtotal", "Discount", "Final Total", "Profit", "Payment", "Items"],
    "Expenses": ["Date", "Description", "Amount"]
  };
  for (let sheetName in schema) {
    let sheet = ss.getSheetByName(sheetName);
    if (!sheet) sheet = ss.insertSheet(sheetName);
    if (sheet.getLastRow() === 0) sheet.getRange(1, 1, 1, schema[sheetName].length).setValues([schema[sheetName]]).setFontWeight("bold").setBackground("#cbd5e1").setHorizontalAlignment("center");
  }
}

function responseJSON(data) {
  return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON);
}