/**
 * SISTEM KASIR RUKO POS BACKEND (GAS) v7 - SUPPORT MULTI SATUAN
 * Update: Menambahkan kolom 'Multi Data' untuk menyimpan konfigurasi Dus/Lusin/Grosir.
 */

const SHEET_PRODUCTS = "Products";
const SHEET_TRANSACTIONS = "Transactions";
const SHEET_EXPENSES = "Expenses";

function onOpen() {
  SpreadsheetApp.getUi().createMenu('ðŸª Admin Ruko POS')
      .addItem('âš¡ Setup Database', 'setupDatabase')
      .addToUi();
}

function doGet(e) {
  const action = e.parameter.action;
  if (action == "get_products") return getProducts();
  return responseJSON({status: 'error', message: 'Unknown action'});
}

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action;

    if (action == "overwrite_full") {
      return overwriteFull(data.products, data.transactions, data.expenses);
    } 
    
    return responseJSON({status: 'error', message: 'Unknown action'});
  } catch (err) {
    return responseJSON({status: 'error', message: err.toString()});
  }
}

// --- LOGIKA DATABASE ---

function getProducts() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEET_PRODUCTS);
  if (!sheet) return responseJSON({status: 'error', message: 'Database belum disetup.'});
  
  const data = sheet.getDataRange().getValues();
  data.shift(); // Hapus header
  
  const products = data.map(row => {
    // Ambil data Multi Unit dari kolom ke-8 (Index 7)
    let multiData = {};
    try {
      if (row[7] && row[7] !== "") {
        multiData = JSON.parse(row[7]);
      }
    } catch (e) {
      multiData = {};
    }

    return {
      barcode: String(row[0]).replace(/^'/, ""),
      name: row[1],
      category: row[2],
      price: Number(row[3]),
      cost_price: Number(row[4]),
      stock: Number(row[5]),
      image: row[6],
      // Gabungkan data flat dengan data multi unit
      base_unit: multiData.base_unit || 'Pcs',
      multi_units: multiData.multi_units || []
    };
  });

  return responseJSON({status: 'success', products: products});
}

function overwriteFull(products, transactions, expenses) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheetProd = ss.getSheetByName(SHEET_PRODUCTS);
  let sheetTx = ss.getSheetByName(SHEET_TRANSACTIONS);
  let sheetExp = ss.getSheetByName(SHEET_EXPENSES);

  if (!sheetProd || !sheetTx || !sheetExp) { 
    setupDatabase();
    return responseJSON({status: 'error', message: 'Database baru disetup. Silakan coba lagi.'});
  }

  // 1. UPDATE STOK & DATA PRODUK (Source of Truth dari HP)
  if (sheetProd.getLastRow() > 1) {
    sheetProd.getRange(2, 1, sheetProd.getLastRow() - 1, sheetProd.getLastColumn()).clearContent();
  }
  
  if (products.length > 0) {
    const rows = products.map(p => {
      // Bungkus data multi satuan jadi JSON String agar muat di 1 kolom
      const multiDataString = JSON.stringify({
        base_unit: p.base_unit || 'Pcs',
        multi_units: p.multi_units || []
      });

      return [
        `'${p.barcode}`, 
        p.name, 
        p.category || 'Umum', 
        p.price, 
        p.cost_price || 0, 
        p.stock, 
        p.image || '',
        multiDataString // <--- KOLOM BARU DI SINI
      ];
    });

    // Simpan ke 8 Kolom (tambah 1 kolom dibanding versi lama)
    sheetProd.getRange(2, 1, rows.length, 8).setValues(rows);
  }

  // 2. CATAT LOG TRANSAKSI BARU
  if (transactions && transactions.length > 0) {
    const txRows = transactions.map(t => [
      new Date(t.date).toLocaleString('id-ID'),
      t.total, t.discount || 0, t.finalTotal || t.total, t.profit || 0,
      t.type === 'debt' ? `KASBON (${t.customerName})` : 'TUNAI',
      JSON.stringify(t.items.map(i => `${i.name} (${i.unit||'Pcs'}) x${i.qty}`)).replace(/[\[\]"]/g, '')
    ]);
    sheetTx.getRange(sheetTx.getLastRow() + 1, 1, txRows.length, 7).setValues(txRows);
  }

  // 3. CATAT PENGELUARAN BARU
  if (expenses && expenses.length > 0) {
    const expRows = expenses.map(e => [
      new Date(e.date).toLocaleString('id-ID'), e.desc, e.amount
    ]);
    sheetExp.getRange(sheetExp.getLastRow() + 1, 1, expRows.length, 3).setValues(expRows);
  }

  return responseJSON({status: 'success', message: 'Data Server Berhasil Disamakan dengan HP!'});
}

function setupDatabase() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  // UPDATE SCHEMA: Tambah kolom "Multi Data" di Products
  const schema = {
    "Products": ["Barcode", "Name", "Category", "Price", "Cost Price", "Stock", "Image", "Multi Data"],
    "Transactions": ["Date", "Subtotal", "Discount", "Final Total", "Profit", "Payment", "Items"],
    "Expenses": ["Date", "Description", "Amount"]
  };
  for (let sheetName in schema) {
    let sheet = ss.getSheetByName(sheetName);
    if (!sheet) sheet = ss.insertSheet(sheetName);
    
    // Selalu update header (baris 1) untuk memastikan kolom baru muncul
    sheet.getRange(1, 1, 1, schema[sheetName].length)
         .setValues([schema[sheetName]])
         .setFontWeight("bold")
         .setBackground("#cbd5e1")
         .setHorizontalAlignment("center");
  }
}

function responseJSON(data) {
  return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON);
}